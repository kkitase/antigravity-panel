# Fork å…ƒï¼ˆupstreamï¼‰ã¨ã®è‡ªå‹•åŒæœŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# n2ns/antigravity-panel ã® main ãƒ–ãƒ©ãƒ³ãƒã¨è‡ªå‹•çš„ã«åŒæœŸã‚’å–ã‚Šã¾ã™
name: Sync Upstream

on:
  # æ¯æ—¥ UTC 0:00ï¼ˆæ—¥æœ¬æ™‚é–“ 9:00ï¼‰ã«å®Ÿè¡Œ
  schedule:
    - cron: "0 0 * * *"

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      branch:
        description: "åŒæœŸã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒå"
        required: false
        default: "main"

permissions:
  contents: write

jobs:
  sync:
    name: Sync with Upstream
    runs-on: ubuntu-latest

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # upstream ãƒªãƒ¢ãƒ¼ãƒˆã‚’è¿½åŠ 
      - name: Add Upstream Remote
        run: |
          git remote add upstream https://github.com/n2ns/antigravity-panel.git || true
          git fetch upstream

      # åŒæœŸã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’æ±ºå®š
      - name: Determine Branch
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          else
            echo "branch=main" >> $GITHUB_OUTPUT
          fi

      # upstream ã®å¤‰æ›´ã‚’ãƒãƒ¼ã‚¸
      - name: Sync with Upstream
        id: sync
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’è¨­å®š
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã«åˆ‡ã‚Šæ›¿ãˆ
          git checkout "$BRANCH"

          # upstream ã‹ã‚‰ã®å¤‰æ›´ã‚’ç¢ºèª
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/"$BRANCH" --count 2>/dev/null || echo "0")

          if [ "$UPSTREAM_COMMITS" -eq 0 ]; then
            echo "âœ… Already up to date with upstream/$BRANCH"
            echo "synced=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“¦ Found $UPSTREAM_COMMITS new commit(s) from upstream/$BRANCH"

          # ãƒãƒ¼ã‚¸ã‚’è©¦è¡Œï¼ˆfast-forward ã®ã¿ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ™‚ã¯å¤±æ•—ï¼‰
          if git merge upstream/"$BRANCH" --ff-only; then
            echo "âœ… Fast-forward merge successful"
            echo "synced=true" >> $GITHUB_OUTPUT
            echo "merge_type=fast-forward" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Fast-forward merge not possible, attempting regular merge..."
            
            # é€šå¸¸ã®ãƒãƒ¼ã‚¸ã‚’è©¦è¡Œ
            if git merge upstream/"$BRANCH" --no-edit; then
              echo "âœ… Merge successful"
              echo "synced=true" >> $GITHUB_OUTPUT
              echo "merge_type=merge" >> $GITHUB_OUTPUT
            else
              echo "âŒ Merge conflict detected. Manual intervention required."
              git merge --abort
              echo "synced=false" >> $GITHUB_OUTPUT
              echo "conflict=true" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      # å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push Changes
        if: steps.sync.outputs.synced == 'true'
        run: |
          BRANCH="${{ steps.branch.outputs.branch }}"
          git push origin "$BRANCH"
          echo "ğŸš€ Pushed changes to origin/$BRANCH"

      # åŒæœŸçµæœã®ã‚µãƒãƒªãƒ¼ã‚’å‡ºåŠ›
      - name: Summary
        run: |
          echo "## ğŸ”„ Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Upstream | \`n2ns/antigravity-panel\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ steps.branch.outputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.sync.outputs.synced }}" == "true" ]; then
            echo "| Status | âœ… Synced (${{ steps.sync.outputs.merge_type }}) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sync.outputs.conflict }}" == "true" ]; then
            echo "| Status | âŒ Conflict (manual intervention needed) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Status | âœ… Already up to date |" >> $GITHUB_STEP_SUMMARY
          fi

      # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç™ºç”Ÿæ™‚ã¯ Issue ã‚’ä½œæˆ
      - name: Create Issue on Conflict
        if: failure() && steps.sync.outputs.conflict == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”€ Upstream sync conflict detected';
            const body = `## Upstream åŒæœŸã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸ

            **Branch**: \`${{ steps.branch.outputs.branch }}\`
            **Upstream**: \`n2ns/antigravity-panel\`
            **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### è§£æ±ºæ–¹æ³•

            ãƒ­ãƒ¼ã‚«ãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ã¦ãã ã•ã„ï¼š

            \`\`\`bash
            git remote add upstream https://github.com/n2ns/antigravity-panel.git || true
            git fetch upstream
            git merge upstream/${{ steps.branch.outputs.branch }}
            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ‰‹å‹•ã§è§£æ±º
            git commit
            git push origin ${{ steps.branch.outputs.branch }}
            \`\`\`
            `;

            // æ—¢å­˜ã®åŒæ§˜ã® Issue ã‚’ãƒã‚§ãƒƒã‚¯
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync']
              });
            }
